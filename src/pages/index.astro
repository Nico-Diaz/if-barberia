---
import Layout from '../layouts/Layout.astro';
import BookingSection from '../components/BookingSection.astro';
import { databases, DATABASE_ID, COLLECTION_TURNOS, COLLECTION_DIAS_ESPECIALES } from '../lib/appwrite';
import { ID, Query } from 'appwrite';
import { servicios } from '../config/servicios';

let mensajeError = "";

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const nombre = formData.get('nombre') as string;
  const apellido = formData.get('apellido') as string;
  const fecha = formData.get('fecha') as string;
  const hora = formData.get('hora') as string;
  const telefono = formData.get('telefono') as string;
  const servicioId = formData.get('servicio') as string;

  try {
    const servicioEncontrado = servicios.find(s => s.id === servicioId);
    if (!servicioEncontrado) throw new Error("Servicio inválido.");

    // 1. Validar si el horario ya está ocupado en Appwrite
    const turnosExistentes = await databases.listDocuments(
      DATABASE_ID,
      COLLECTION_TURNOS,
      [
        Query.equal('fecha', fecha),
        Query.equal('hora', hora)
      ]
    );

    if (turnosExistentes.total > 0) throw new Error(`El horario de las ${hora} ya está ocupado.`);

    // 2. Guardar el nuevo turno
    await databases.createDocument(
      DATABASE_ID,
      COLLECTION_TURNOS,
      ID.unique(),
      {
        nombre,
        apellido,
        fecha,
        hora,
        telefono,
        servicio: servicioEncontrado.nombre
      }
    );

    return Astro.redirect(`/exito?nombre=${nombre}&fecha=${fecha}&hora=${hora}`);

  } catch (error: any) {
    mensajeError = error.message || "Error al procesar el turno.";
  }
}
---

<Layout title="Reservar Turno | IF Barbería">
    <main class="app-wrapper">
        <div class="brand-header">
            <h1 style="font-family: var(--font-titles); font-size: 3rem; text-align: center;">
				<span style="color: var(--color-primary);">IF</span> 
				<span style="color: var(--color-white);">BARBERÍA</span>
			</h1>
            <div class="bar-decorator"></div>
            <p>Reserva tu lugar exclusivo</p>
        </div>
        <BookingSection errorBackend={mensajeError} />
        <footer class="mini-footer"><p>© 2026 IF Barbería</p></footer>
    </main>
</Layout>

<style>
    /* Mantenemos los mismos estilos de la bandera de Francia que definimos antes */
    .app-wrapper { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
    .brand-header h1 { font-family: var(--font-titles); font-size: 3.5rem; letter-spacing: 4px; margin: 0; line-height: 1; }
    .text-blue { color: var(--color-primary); }
    .text-red { color: var(--color-secondary); }
    .bar-decorator {
        height: 4px; width: 60px;
        background: linear-gradient(to right, var(--color-primary) 33%, var(--color-white) 33%, var(--color-white) 66%, var(--color-secondary) 66%);
        margin: 10px auto;
    }
</style>