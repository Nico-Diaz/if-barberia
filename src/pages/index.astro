---
// src/pages/index.astro
import Layout from '../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';

// --- BLOQUE DE SEGURIDAD ---
let negocios = [];
let errorMensaje = null;

try {
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseKey = import.meta.env.PUBLIC_SUPABASE_KEY;

    if (!supabaseUrl || !supabaseKey) {
        throw new Error("Faltan las credenciales de Supabase en el archivo .env");
    }

    const supabase = createClient(supabaseUrl, supabaseKey);

    // Intentamos buscar los negocios
    const { data, error } = await supabase.from('negocios').select('*');
    
    if (error) {
        throw error;
    }
    
    negocios = data || [];

} catch (err) {
    console.error("Error crítico en index.astro:", err);
    errorMensaje = err.message;
}
---

<Layout title="Mis Clientes | Multi-Turnero">
    <main class="central-hub">
        <h1>MIS CLIENTES</h1>
        <p>Selecciona un negocio para ver su turnero:</p>

        {errorMensaje && (
            <div class="error-box">
                <h3>⚠️ Ocurrió un error</h3>
                <p>{errorMensaje}</p>
                <small>Revisa la consola (Terminal) para más detalles.</small>
            </div>
        )}

        <div class="grid-negocios">
            {negocios.length > 0 ? (
                negocios.map((negocio) => (
                    <a href={`/${negocio.slug}`} class="card-negocio" style={`border-color: ${negocio.color_primario}`}>
                        <h2 style={`color: ${negocio.color_primario}`}>{negocio.nombre}</h2>
                        <span class="badge">{negocio.tipo}</span>
                        <p class="link">Ir al sitio &rarr;</p>
                    </a>
                ))
            ) : (
                !errorMensaje && <p class="empty-msg">No se encontraron negocios cargados en la base de datos.</p>
            )}
        </div>
    </main>
</Layout>

<style>
    .central-hub {
        min-height: 100vh; background: #0f172a; color: white;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px;
    }
    h1 { letter-spacing: 5px; margin-bottom: 10px; text-align: center; line-height: 1.2; }
    
    .grid-negocios { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
        gap: 20px; width: 100%; max-width: 800px; margin-top: 30px; 
    }
    
    .card-negocio {
        background: #1e293b; padding: 25px; border-radius: 15px; border: 2px solid #333;
        text-decoration: none; transition: 0.3s; display: flex; flex-direction: column; gap: 10px;
    }
    .card-negocio:hover { transform: translateY(-5px); background: #252f45; }
    h2 { margin: 0; font-size: 1.5rem; }
    .badge { 
        background: #334155; color: #94a3b8; padding: 4px 10px; 
        border-radius: 20px; font-size: 0.8rem; width: fit-content; text-transform: uppercase; 
    }
    .link { margin: 0; margin-top: auto; font-size: 0.9rem; color: white; opacity: 0.7; }

    /* Estilos de Error */
    .error-box {
        background: rgba(220, 38, 38, 0.2);
        border: 1px solid #dc2626;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
        max-width: 600px;
    }
    .empty-msg { color: #94a3b8; font-style: italic; margin-top: 20px; }

    /* RESPONSIVE */
    @media (max-width: