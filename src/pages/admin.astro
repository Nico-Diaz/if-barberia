---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

export const prerender = false;
Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");
if (!accessToken || !refreshToken) return Astro.redirect('/login');

const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken.value);
if (authError || !user) return Astro.redirect('/login');

let mensajeExito = "";
let mensajeError = "";

if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const action = formData.get('action');

    if (action === 'logout') {
        await supabase.auth.signOut();
        Astro.cookies.delete("sb-access-token", { path: "/" });
        Astro.cookies.delete("sb-refresh-token", { path: "/" });
        return Astro.redirect('/login');
    }
    if (action === 'delete') {
        const idToDelete = formData.get('id');
        if (idToDelete) await supabase.from('turnos').delete().eq('id', idToDelete);
    }
    if (action === 'update_hora') {
        const idToUpdate = formData.get('id');
        const nuevaHora = formData.get('nueva_hora');
        if (idToUpdate && nuevaHora) {
            await supabase.from('turnos').update({ hora: nuevaHora }).eq('id', idToUpdate);
            mensajeExito = "Horario actualizado.";
        }
    }
    if (action === 'save_day') {
        const fecha = formData.get('fecha_especial') as string;
        const tipo = formData.get('tipo_dia'); 
        if (fecha) {
            const esCerrado = tipo === 'cerrado';
            let horaInicio = formData.get('hora_inicio') as string;
            let horaFin = formData.get('hora_fin') as string;
            
            const payload = {
                fecha, cerrado: esCerrado,
                hora_inicio: (esCerrado || !horaInicio) ? null : horaInicio,
                hora_fin: (esCerrado || !horaFin) ? null : horaFin
            };
            const { error } = await supabase.from('dias_especiales').upsert(payload);
            if (error) mensajeError = `Error: ${error.message}`;
            else mensajeExito = "Regla guardada correctamente.";
        }
    }
    if (action === 'delete_day') {
        const fecha = formData.get('fecha_borrar');
        if (fecha) {
            await supabase.from('dias_especiales').delete().eq('fecha', fecha);
            mensajeExito = "Regla eliminada.";
        }
    }
}

const hoy = new Date().toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit' }).split('/').reverse().join('-');
const { data: turnos } = await supabase.from('turnos').select('*').order('fecha', { ascending: true }).order('hora', { ascending: true });
const listaTurnos = turnos || [];
const { data: diasEspeciales } = await supabase.from('dias_especiales').select('*').gte('fecha', hoy).order('fecha', { ascending: true });
const listaDias = diasEspeciales || [];
---

<Layout title="Admin | Barber√≠a Ezequiel Marin">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">

    <div class="admin-wrapper">
        <header class="admin-header">
            <div class="titulo"><h1>BARBER√çA EZEQUIEL MARIN</h1><p>Panel de Administraci√≥n</p></div>
            <form method="POST"><input type="hidden" name="action" value="logout"><button type="submit" class="btn-logout">SALIR</button></form>
        </header>

        {mensajeExito && <div class="toast-success">{mensajeExito}</div>}
        {mensajeError && <div class="toast-error">{mensajeError}</div>}

        <h2 class="section-title">üìÖ Pr√≥ximos Turnos</h2>
        <div class="table-container">
            {listaTurnos.length === 0 ? <div class="empty-state"><p>No hay turnos.</p></div> : (
                <table class="responsive-table">
                    <thead><tr><th>FECHA</th><th>HORARIO</th><th>SERVICIO</th><th>CLIENTE</th><th>CONTACTO</th><th>ACCI√ìN</th></tr></thead>
                    <tbody>
                        {listaTurnos.map((turno) => (
                            <tr class={turno.fecha === hoy ? "es-hoy" : ""}>
                                <td data-label="FECHA"><div class="fecha-celda">{turno.fecha.split('-').reverse().join('/')}{turno.fecha === hoy && <span class="badge-hoy">HOY</span>}</div></td>
                                <td data-label="HORARIO">
                                    <form method="POST" class="form-cambio-hora">
                                        <input type="hidden" name="action" value="update_hora"><input type="hidden" name="id" value={turno.id}>
                                        <div class="hora-input-wrapper">
                                            <input type="time" name="nueva_hora" value={turno.hora} class="input-time-admin" required />
                                            <button type="submit" class="btn-save-time" title="Guardar">‚úì</button>
                                        </div>
                                    </form>
                                </td>
                                <td data-label="SERVICIO"><span class="servicio-badge">{turno.servicio || '-'}</span></td>
                                <td data-label="CLIENTE" class="cliente-text">{turno.nombre} {turno.apellido}</td>
                                <td data-label="CONTACTO">{turno.telefono ? <a href={`https://wa.me/${turno.telefono}`} target="_blank" class="whatsapp-btn">WhatsApp</a> : '-'}</td>
                                <td data-label="ACCI√ìN">
                                    <form method="POST" id={`form-borrar-${turno.id}`}>
                                        <input type="hidden" name="action" value="delete"><input type="hidden" name="id" value={turno.id} />
                                        <button type="button" class="btn-small-delete accion-borrar" data-id={turno.id} data-nombre={`${turno.nombre} ${turno.apellido}`}>BORRAR</button>
                                    </form>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            )}
        </div>

        <hr class="divider" />

        <h2 class="section-title">‚öôÔ∏è Gestionar D√≠as y Horarios</h2>
        <div class="card-config">
            <form method="POST" class="form-config">
                <input type="hidden" name="action" value="save_day">
                <div class="config-row">
                    <div class="input-group">
                        <label>Fecha</label>
                        <input type="text" id="admin-fecha-picker" name="fecha_especial" required placeholder="Seleccionar d√≠a..." class="input-admin" readonly>
                    </div>
                    <div class="input-group">
                        <label>Acci√≥n</label>
                        <select name="tipo_dia" id="tipoSelect" class="input-admin" onchange="toggleHorarios(this.value)">
                            <option value="cerrado">üîí Cerrar D√≠a</option>
                            <option value="personalizado">‚è∞ Cambiar Horario</option>
                        </select>
                    </div>
                    <div id="horariosInputs" class="horarios-group" style="display:none;">
                        <div class="input-group"><label>Apertura</label><input type="time" name="hora_inicio" class="input-admin"></div>
                        <div class="input-group"><label>Cierre</label><input type="time" name="hora_fin" class="input-admin"></div>
                    </div>
                    <button type="submit" class="btn-save">GUARDAR REGLA</button>
                </div>
            </form>
            <div class="lista-dias-especiales">
                <h3>Reglas Activas:</h3>
                {listaDias.length === 0 ? <p class="text-muted">No hay reglas especiales.</p> : (
                    <div class="grid-dias">
                        {listaDias.map(dia => (
                            <div class="dia-card">
                                <span class="dia-fecha">{dia.fecha.split('-').reverse().join('/')}</span>
                                <span class={`dia-estado ${dia.cerrado ? 'cerrado' : 'abierto'}`}>
                                    {dia.cerrado ? 'CERRADO' : `‚è∞ ${dia.hora_inicio} - ${dia.hora_fin}`}
                                </span>
                                <form method="POST" style="margin-top: 5px;">
                                    <input type="hidden" name="action" value="delete_day"><input type="hidden" name="fecha_borrar" value={dia.fecha}>
                                    <button type="submit" class="btn-small-delete">BORRAR</button>
                                </form>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    </div>
</Layout>

<script is:inline src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script is:inline src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
<script>
    import Swal from 'sweetalert2';
    declare global { interface Window { toggleHorarios: (valor: string) => void; } }
    document.addEventListener('DOMContentLoaded', function() {
        // @ts-ignore
        flatpickr("#admin-fecha-picker", { locale: "es", minDate: "today", dateFormat: "Y-m-d", disableMobile: "true" });
    });
    window.toggleHorarios = (valor: string) => {
        const div = document.getElementById('horariosInputs');
        if (div) div.style.display = (valor === 'personalizado') ? 'flex' : 'none';
    }
    document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const boton = target.closest('.accion-borrar');
        if (boton) {
            const id = boton.getAttribute('data-id');
            const nombre = boton.getAttribute('data-nombre');
            const form = document.getElementById(`form-borrar-${id}`) as HTMLFormElement;
            if (form) Swal.fire({ title: '¬øEliminar?', text: `${nombre}`, icon: 'warning', background: '#1a1a1a', color: '#fff', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, borrar' }).then((r) => { if (r.isConfirmed) form.submit(); });
        }
    });
    const toast = document.querySelector('.toast-success');
    if (toast) setTimeout(() => { (toast as HTMLElement).style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
</script>

<style>
    /* Estilos Admin (Resumen) */
    .admin-wrapper { min-height: 100vh; background-color: #121212; padding: 40px 20px; color: #d4af37; font-family: 'Montserrat', sans-serif; }
    .admin-header { max-width: 1000px; margin: 0 auto 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(242, 240, 230, 0.1); padding-bottom: 20px; }
    .titulo h1 { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; margin: 0; letter-spacing: 1px; }
    .titulo p { font-size: 0.9rem; opacity: 0.6; color: #fff; margin-top: 5px; }
    .btn-logout { background: rgba(255, 255, 255, 0.1); border: none; color: #fff; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .btn-logout:hover { background: #d33; }
    .section-title { max-width: 1000px; margin: 0 auto 20px; font-size: 1.2rem; border-left: 4px solid #d4af37; padding-left: 10px; color: #fff; }
    
    .table-container { max-width: 1000px; margin: 0 auto; background: rgba(255, 255, 255, 0.03); border-radius: 12px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 18px; background: rgba(0, 0, 0, 0.4); font-size: 0.75rem; letter-spacing: 1px; color: rgba(242, 240, 230, 0.5); }
    td { padding: 18px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #eee; }
    .es-hoy { background: rgba(46, 204, 113, 0.08); }
    .es-hoy td:first-child { border-left: 4px solid #2ecc71; }
    .badge-hoy { background: #2ecc71; color: #000; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 8px; }
    .btn-small-delete { background: transparent; color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; cursor: pointer; display: inline-block; text-transform: uppercase; }
    .btn-small-delete:hover { background: #ff6b6b; color: #fff; }
    
    .card-config { max-width: 1000px; margin: 0 auto; background: rgba(255,255,255,0.03); padding: 25px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .config-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 20px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-size: 0.75rem; color: #d4af37; font-weight: bold; }
    .input-admin { background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; color-scheme: dark; }
    .btn-save { background: #d4af37; color: #000; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; height: 43px; }
    .btn-save:hover { background: #fff; }
    
    .hora-input-wrapper { display: flex; gap: 8px; align-items: center; }
    .input-time-admin { background: rgba(0,0,0,0.3); color: #d4af37; border: 1px solid rgba(242, 240, 230, 0.2); padding: 5px; border-radius: 6px; color-scheme: dark; }
    .btn-save-time { background: transparent; border: 1px solid #2ecc71; color: #2ecc71; border-radius: 6px; cursor: pointer; padding: 4px 8px; font-weight: bold; }
    .btn-save-time:hover { background: #2ecc71; color: #000; }
    
    .grid-dias { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin-top: 15px; }
    .dia-card { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; text-align: center; }
    .dia-fecha { display: block; font-weight: bold; margin-bottom: 5px; color: #fff; }
    .dia-estado { font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
    .dia-estado.cerrado { background: rgba(255, 107, 107, 0.15); color: #ff6b6b; }
    .dia-estado.abierto { background: rgba(46, 204, 113, 0.15); color: #2ecc71; }
    
    .toast-success { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #2ecc71; color: #000; padding: 12px 24px; border-radius: 50px; z-index: 1000; font-weight: bold; }
    .toast-error { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: #fff; padding: 12px 24px; border-radius: 50px; z-index: 1000; font-weight: bold; }

    @media (max-width: 768px) {
        .table-container { background: transparent; }
        table thead { display: none; }
        table, tr, td { display: block; width: 100%; }
        tr { background: rgba(255, 255, 255, 0.05); margin-bottom: 20px; border-radius: 12px; padding: 15px; }
        td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 10px 0; }
        td::before { content: attr(data-label); float: left; font-weight: bold; font-size: 0.7rem; color: rgba(242, 240, 230, 0.4); }
        .config-row { flex-direction: column; align-items: stretch; }
        .horarios-group { flex-direction: column; }
    }
</style>