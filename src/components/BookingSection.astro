---
import { servicios, barberos, formatearPrecio } from '../config/servicios';
import { databases, DATABASE_ID, COLLECTION_DIAS_ESPECIALES } from '../lib/appwrite';
import { Query } from 'appwrite';

interface Props { errorBackend?: string; }
const { errorBackend } = Astro.props;

// --- 1. CARGA DE DÍAS ESPECIALES (BACKEND) ---
let excepcionesJSON = "[]";
try {
    const hoy = new Date().toISOString().split('T')[0];
    const respuesta = await databases.listDocuments(
        DATABASE_ID,
        COLLECTION_DIAS_ESPECIALES,
        [Query.greaterThanEqual('fecha', hoy)]
    );
    excepcionesJSON = JSON.stringify(respuesta.documents);
} catch (e) {
    console.error("Error Appwrite:", e);
    // Si falla, seguimos con un array vacío para no romper el calendario
    excepcionesJSON = "[]"; 
}
---

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">

<div class="booking-container">
    {errorBackend && <div class="error-msg">⚠️ {errorBackend}</div>}

    <form method="POST" class="form-card">
        
        <div class="section-block">
            <h3 class="step-title">1. Selecciona el Servicio</h3>
            <div class="options-container">
                {servicios.map((s) => (
                    <label class="option-card">
                        <input type="radio" name="servicio" value={s.nombre} required>
                        <div class="card-inner blue-theme">
                            <span class="text-main">{s.nombre}</span>
                            <span class="text-sub">{formatearPrecio(s.precio)}</span>
                        </div>
                    </label>
                ))}
            </div>
        </div>

        <div class="section-block">
            <h3 class="step-title">2. Elige tu Barbero</h3>
            <div class="options-container three-cols">
                {barberos.map((b) => (
                    <label class="option-card">
                        <input type="radio" name="barbero" value={b.nombre} required>
                        <div class="card-inner red-theme">
                            <span class="text-main">{b.nombre}</span>
                        </div>
                    </label>
                ))}
            </div>
        </div>

        <div class="section-block">
            <h3 class="step-title">3. ¿Cuándo vienes?</h3>
            
            <div class="inputs-container">
                <div class="form-row">
                    <input type="text" name="fecha" id="input-fecha" placeholder="Toca para elegir día" required class="input-field pointer">
                    
                    <select name="hora" id="select-hora" required disabled class="input-field">
                        <option value="" disabled selected>Hora</option>
                    </select>
                </div>

                <div class="form-row">
                    <input type="text" name="nombre" placeholder="Nombre" required class="input-field">
                    <input type="text" name="apellido" placeholder="Apellido" required class="input-field">
                </div>

                <div class="form-row">
                    <input type="tel" name="telefono" placeholder="WhatsApp (Ej: 11 1234 5678)" class="input-field full">
                </div>
            </div>
        </div>

        <button type="submit" class="btn-submit">RESERVAR TURNO</button>
    </form>
</div>

<script is:inline src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script is:inline src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

<script define:vars={{ excepcionesJSON }}>
    // Configuración de Horarios
    const horariosConfig = {
        0: null, // Domingo cerrado
        1: { inicio: "10:00", fin: "19:00" }, 
        2: { inicio: "10:00", fin: "20:00" },
        3: { inicio: "10:00", fin: "19:00" },
        4: { inicio: "10:00", fin: "20:00" },
        5: { inicio: "10:00", fin: "19:00" },
        6: { inicio: "10:00", fin: "20:00" }
    };

    // Aseguramos que sea un array válido aunque venga vacío
    let diasEspeciales = [];
    try {
        diasEspeciales = JSON.parse(excepcionesJSON);
    } catch (e) {
        console.error("Error parseando JSON dias especiales", e);
    }

    const intervaloMinutos = 30;

    document.addEventListener('DOMContentLoaded', function() {
        const inputFecha = document.getElementById('input-fecha');
        const selectHora = document.getElementById('select-hora');

        if (!inputFecha || !selectHora) {
            console.error("No se encontraron los inputs de fecha u hora");
            return;
        }

        console.log("Iniciando Flatpickr...");

        flatpickr(inputFecha, {
            locale: "es",
            minDate: "today",
            dateFormat: "Y-m-d",
            disableMobile: "true", // Importante para que use nuestro diseño
            clickOpens: true,      // Fuerza apertura al clic
            
            // Bloqueo de días
            disable: [
                function(date) {
                    const fechaStr = date.toISOString().split('T')[0];
                    const diaSemana = date.getDay();
                    
                    // 1. Regla especial (vacaciones/feriado)
                    const regla = diasEspeciales.find(d => d.fecha === fechaStr);
                    if (regla && regla.cerrado) return true;

                    // 2. Domingo cerrado
                    return (diaSemana === 0);
                }
            ],

            // Al elegir fecha -> Generar Horas
            onChange: function(selectedDates, dateStr) {
                console.log("Fecha seleccionada:", dateStr);
                
                selectHora.innerHTML = '<option value="" disabled selected>Cargando...</option>';
                selectHora.disabled = true;

                if (selectedDates.length === 0) return;

                const fechaElegida = selectedDates[0];
                const diaSemana = fechaElegida.getDay();
                
                // Buscar configuración de horario
                let inicio = "10:00", fin = "20:00"; 
                const configDia = horariosConfig[diaSemana];

                // Si hay regla especial de horario, sobreescribe
                const regla = diasEspeciales.find(d => d.fecha === dateStr);
                if (regla && !regla.cerrado) {
                    inicio = regla.hora_inicio;
                    fin = regla.hora_fin;
                } else if (configDia) {
                    inicio = configDia.inicio;
                    fin = configDia.fin;
                } else {
                    selectHora.innerHTML = '<option value="" disabled selected>Cerrado</option>';
                    return;
                }

                // Generar opciones
                selectHora.innerHTML = '<option value="" disabled selected>Selecciona hora</option>';
                
                let [hActual, mActual] = inicio.split(':').map(Number);
                let [hFin, mFin] = fin.split(':').map(Number);
                
                let minActual = hActual * 60 + mActual;
                let minFin = hFin * 60 + mFin;

                const ahora = new Date();
                const esHoy = fechaElegida.toDateString() === ahora.toDateString();

                while (minActual < minFin) {
                    let h = Math.floor(minActual / 60);
                    let m = minActual % 60;
                    let horaTexto = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    
                    let mostrar = true;
                    // Si es hoy, ocultar horas pasadas (+15 min margen)
                    if (esHoy) {
                        let horaCheck = new Date();
                        horaCheck.setHours(h, m, 0, 0);
                        if (horaCheck < new Date(ahora.getTime() + 15*60000)) mostrar = false;
                    }

                    if (mostrar) {
                        let opt = document.createElement('option');
                        opt.value = horaTexto;
                        opt.textContent = horaTexto;
                        selectHora.appendChild(opt);
                    }
                    minActual += intervaloMinutos;
                }
                
                selectHora.disabled = false;
            }
        });
    });
</script>

<style>
    /* RESET */
    * { box-sizing: border-box; }

    /* --- FIX IMPORTANTE: CALENDARIO VISIBLE --- */
    /* Esto asegura que el calendario se vea por encima de todo */
    .flatpickr-calendar {
        z-index: 9999 !important;
    }

    .booking-container {
        width: 100%;
        max-width: 550px;
        margin: 0 auto;
        padding: 10px;
    }

    .form-card {
        background: #0f172a;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 1.5rem;
        padding: 2.5rem 2rem;
        display: flex;
        flex-direction: column;
        gap: 3.5rem; 
    }

    .step-title {
        color: white;
        font-family: var(--font-titles, sans-serif);
        text-align: center;
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        letter-spacing: 1.5px;
        text-transform: uppercase;
    }

    /* TARJETAS */
    .options-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .three-cols { grid-template-columns: 1fr 1fr 1fr; }
    
    .option-card input { display: none; }
    
    .card-inner {
        background: #1e293b;
        border: 2px solid transparent;
        padding: 15px;
        border-radius: 16px;
        text-align: center;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 90px;
        height: 100%;
        transition: 0.2s;
    }

    .text-main { font-weight: bold; font-size: 0.95rem; color: #fff; text-transform: uppercase; }
    .text-sub { font-size: 0.8rem; color: #94a3b8; margin-top: 6px; }

    input:checked + .blue-theme { background: var(--color-primary, #002395); border-color: white; transform: scale(1.02); }
    input:checked + .red-theme { background: var(--color-secondary, #b91c1c); border-color: white; transform: scale(1.02); }

    /* INPUTS */
    .inputs-container { display: flex; flex-direction: column; gap: 15px; }
    .form-row { display: flex; gap: 15px; width: 100%; }

    .input-field {
        flex: 1;
        width: 100%;
        background: #1e293b;
        border: 1px solid rgba(255,255,255,0.1);
        color: white;
        padding: 18px;
        border-radius: 12px;
        font-size: 1rem;
        text-align: center;
        outline: none;
        appearance: none; 
    }

    .input-field:focus { border-color: var(--color-primary, #002395); background: #252f45; }
    
    /* CURSOR PARA FECHA */
    #input-fecha { cursor: pointer; } 

    .btn-submit {
        background: var(--color-secondary, #b91c1c);
        color: white;
        border: none;
        padding: 22px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 1.4rem;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
        font-family: var(--font-titles, sans-serif);
        letter-spacing: 2px;
        transition: 0.2s;
    }
    
    .btn-submit:active { transform: scale(0.98); }

    @media (max-width: 500px) {
        .form-card { padding: 2rem 1.5rem; gap: 3rem; }
        .three-cols { grid-template-columns: 1fr 1fr; }
        .form-row { flex-direction: column; gap: 15px; }
        .input-field { padding: 20px; font-size: 1.1rem; }
        .card-inner { min-height: 110px; }
    }
</style>